{% extends 'websocket_app/mainpage.html' %}

{% block header %}
<div class="col-4">
  <div class="text-center fs-4">ChatRoom</div>
</div>
<div class="col-4">
  <div class="row justify-content-center">
  {% if user.is_authenticated %}
    <a class="col-2 text-left p-2" href="{% url 'logout' %}">Выход</a>
  {% else %}
    <a class="col-2 text-center p-2" href="{% url 'register' %}">Регистрация</a>
    <a class="col-2 text-center p-2" href="{% url 'login' %}">Вход</a>
  {% endif %}
  </div>
</div>
{% endblock %}

{% block navigation %}
  <div class="d-grid gap-2">
    <a href="{% url 'home' %}" class="btn btn-dark p-2 mt-3 rounded-0 text-start">Главная</a>
    <a href="#" class="btn btn-dark p-2 rounded-0 text-start">Профиль</a>
    
    {% if user.is_authenticated %}
      <a href="{% url 'logout' %}" class="btn btn-dark p-2 rounded-0 text-start">Выход</a>
    {% else %}
    {% endif %}
  </div>

{% endblock%}


{% block rooms %}
<div class="d-flex m-0 p-0 flex-column h-100" id='rooms-container' hx-get="{% url 'chatrooms' %}" hx-trigger="load, every 5s" hx-target="this">
  {% include 'websocket_app/rooms.html' %}
</div>
{% endblock%}


{% block chatinfo %}
<div class="p-2 text-dark" id="room-name"></div>
{% endblock %}


{% block chatlog %}
<div class="container h-100" >
  <div class="d-flex flex-column-reverse h-100" id="chat-log" style="overflow-y: scroll;">      
  </div>   
</div>
{% endblock %}


{% block chatinput %}
  <div class="d-flex mb-4">
    <input class="form-control m-2" placeholder='Текст сообщения' id="chat-message-input"></input>
    <button class="btn btn-primary rounded-circle m-2" type="button" id="chat-message-submit"> > </button>
  </div>
{% endblock %}


{% block js %}
<script>
function newSocketChatlogConnection(id, name) {
  
  if (window.chatSocket) {
    window.chatSocket.close();
    clearChatlog();
  };

  document.querySelector('#room-name').textContent = name

  window.chatSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/chatroom/" + id + "/"
  );
  window.chatSocket.onmessage = function (e) {
    addChatlogMessage(JSON.parse(e.data))
  };
  window.chatSocket.onclose = function (e) {
    console.log("The old websocket connection is closed");
  };
  window.chatSocket.addEventListener("open", (event) => {
    console.log("The new websocket connection is open");
  }); 
}

function addChatlogMessage(data) {

  // <div class="d-flex flex-column rounded-2 bg-light" style="width:fit-content; max-width: 75%;">
  //     <div class="d-flex justify-content-between align-items-center">
  //       <div class="h6 m-0 p-2">Автор</div>
  //       <div class="text-muted p-2">10:23</div>
  //     </div>
  //     <div class="p-2">
  //         Текст сообщения Текст сообщения Текст 
  //     </div>

  //   </div>


  let user = document.createElement("div");
  user.className = "h6 m-0 p-2";
  user.append(data.user);
  
  let time = document.createElement("div");
  time.className = "text-muted p-2 fs-10";
  
  let time_small = document.createElement("small");
  time_small.append(data.message_time)
  time.append(time_small)

  let text = document.createElement("div");
  text.className = "p-2";
  text.append(data.message_text)
  
  let info = document.createElement("div")
  info.className = "d-flex justify-content-between align-items-center" 
  info.append(user, time)
  
  let message = document.createElement("div")
  message.style = "width:fit-content; max-width: 75%;"
  message.className = "d-flex flex-column m-2 rounded-2 bg-light "
  message.className += (data.user === "{{ user }}") ? "align-self-end" : "align-self-start";
  message.append(info, text)

  document.querySelector("#chat-log").prepend(message);
  // let div_message = document.createElement("div");
  
  // div_user = document.createElement("div");
  // div_user.className = "p-3 m-2 rounded-5 bg-info";
  // div_user.append(data.user);
  
  // div_text = document.createElement("div");
  // div_text.className = "p-3 m-2 rounded-3 bg-light";
  // div_text.append(data.message);
  

  // div_message.className = (data.user === "{{ user }}") ?
  //   (div_message.append(div_text, div_user), "d-flex align-self-end") :
  //   (div_message.append(div_user, div_text), "d-flex align-self-start");

  // document.querySelector("#chat-log").prepend(div_message);
};

function clearChatlog() {
  document.querySelector("#chat-log").innerHTML = "";
};
</script>

{% endblock %}